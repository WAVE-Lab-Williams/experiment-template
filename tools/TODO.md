# Experiment Setup Convenience Notebook

We are implementing a Python notebook to walk a researcher through setting up an experiment
and testing to make sure that it works. The notebook should be titled `setup_experiment.ipynb`
and be located in the `tools/` directory. Unless specifically mentioned, assume all files are to be placed in `tools/`

ONLY EVER IMPLEMENT ONE CELL CHECKLIST TASK AT A TIME. CHECK OFF THE COMPLETED TASK IN THE TODO FILE WHEN COMPLETED

# Setup

- [x] We'll use `uv` for package management, and will need a minimal `pyproject.toml` with black, httpx, ipykernel, pandas, dotenv. WHEN YOU ADD PACKAGES TO `pyproject.toml`, YOU SHOULD USE `uv add` INSTEAD OF GUESSING VERSIONS. Require a python version > 3.10, and put a `.python-version` file as well (specify `3.12`).

- [x] You'll need to install the WAVE python client from github, using `uv add https://github.com/WAVE-Lab-Williams/wave-client/releases/latest/download/wave_client-1.0.0-py3-none-any.whl`

- [x] Create a `.env.example` file with the environment variables `EXPERIMENTEE_API_KEY`, `RESEARCHER_API_KEY`, and `WAVE_BACKEND_URL` ('https://wave-backend-production-8781.up.railway.app', but make sure there's a comment mentioning that the URL must match `params.js`)

# What the notebook should include

- [x] A cell with instructions for setup, pointing the user to install [uv](https://docs.astral.sh/uv/), including the link
- [x] Instructions in the setup cell for installing the pyproject dependencies
- [x] A gentle description of the UV virtual env (including a mention that deleting the `.venv` folder will give you a clean slate)
- [x] A cell that tries to load in wave client `from wave_client import WaveClient` with instructions on what to do if that failed...
- [x] A cell that opens `index.html` (located in ROOT) with webbrowser. Should be a variable located very clearly in the notebook for users to modify in case the location of index changes. Use pathlib over os.path if needed. Do NOT add url parameters in this step.
- [ ] A y/n continue input block asking the user to click through their experiment (which is run locally and not logged), and to check either the console log or the `jsPsych.data.displayData()` for all data GENERATED by the experiment. If not, exit.
- [ ] The instructions should then specify that the data LOGGED in the experiment should be specified by `function processTrialData(data)` in `wave-client.js`
- [ ] We now need to create the experiment in the API. A cell should contain a json dictionary following the parameters defined in processTrialData (wave-cleint.js), and should be of a format accepted by wave_client.models.base.ExperimentTypeCreate (reproduced below). A markdown cell above should specify the reserved_names and supported_types explicitly, and note that STRING is capped at 255 chars. A boolean flag should specify whether we skip creating the experiment or not

```python
class ExperimentTypeCreate(BaseModel):
    """Data for creating a new experiment type."""

    name: str = Field(..., max_length=100, description="Experiment type name")
    table_name: str = Field(..., max_length=100, description="Database table name")
    schema_definition: Dict[str, ColumnDefinition] = Field(
        default_factory=dict, description="Column definitions for experiment data"
    )
    description: Optional[str] = Field(None, description="Experiment type description")

    @field_validator("schema_definition")
    def validate_schema_definition(cls, v):  # pylint: disable=no-self-argument
        """Validate schema definition follows backend rules."""
        reserved_names = {"id", "experiment_uuid", "participant_id", "created_at", "updated_at"}
        supported_types = {"INTEGER", "FLOAT", "STRING", "TEXT", "BOOLEAN", "DATETIME", "JSON"}

        for column_name, column_def in v.items():
            if column_name.lower() in reserved_names:
                raise ValueError(f"Column name '{column_name}' is reserved")

            if isinstance(column_def, str):
                if column_def.upper() not in supported_types:
                    raise ValueError(f"Unsupported column type: {column_def}")
            elif isinstance(column_def, dict):
                if "type" not in column_def:
                    raise ValueError(f"Column definition for '{column_name}' must include 'type'")
                if column_def["type"].upper() not in supported_types:
                    raise ValueError(f"Unsupported column type: {column_def['type']}")
        return v
```

- [ ] A cell loads the json dictionary into the pydantic model for validation.
- [ ] A y/n input validating that the researcher has created their own `.env` file from the example, where the `EXPERIMENTEE_API_KEY` contains only experimentee permissions, is not expired (and conversely, expires at a reasonable time after the experiment ends), that `RESEARCHER_API_KEY` != `EXPERIMENTEE_API_KEY` and that the `WAVE_BACKEND_URL` points to the same one as described in `src/js/core/params.js`
- [ ] Launch the wave client (should probably be in a function). NOTE that this wave client should be initialized with the `RESEARCHER_API_KEY` (the following examples have it as `WAVE_API_KEY` which should be replaced)

```python
import os
import pandas as pd
from datetime import datetime
from dotenv import load_dotenv
from wave_client import WaveClient
from urllib.parse import quote
import webbrowser
from pathlib import Path

# Load environment variables
load_dotenv()
API_KEY = os.getenv("WAVE_API_KEY")
BASE_URL = os.getenv("WAVE_API_URL", "http://localhost:8000")

if not API_KEY:
    raise ValueError("Please set WAVE_API_KEY in your .env file")

print(f"✓ Connecting to {BASE_URL}")
print(f"✓ API Key loaded (ending in: ...{API_KEY[-4:]})")

# Initialize client and test connection
client = WaveClient(api_key=API_KEY, base_url=BASE_URL)

# Test connection
health = await client.get_health()
version = await client.get_version()

print(f"✓ Backend status: {health['status']}")
print(f"✓ API version: {version.get('api_version', 'unknown')}")
```

- [ ] Wave Client tries to create the experiment (unless skipped by the boolean flag). For example:

```python
try:
    exp_type = await client.experiment_types.create(
        name=demo_name,
        table_name=table_name,
        description="Integration demo between Python and JavaScript clients",
        schema_definition={
            "trial_number": "INTEGER",
            "reaction_time": "FLOAT",
            "stimulus_color": "STRING",
            "response_key": "STRING",
            "accuracy": "BOOLEAN",
            "timestamp": "STRING",
            "user_agent": "STRING",
        },
    )
    exp_type_id = exp_type["id"]
    print(f"✓ Created experiment type: {exp_type['name']} (ID: {exp_type_id})")
    print(f"✓ Table name: {exp_type['table_name']}")
except Exception as e:
    print(f"Error creating experiment type: {e}")
    raise
```


- [ ] Generate a unique TEST_... experiment name with some datetime info (or some uuid function). Generate an experimentee id (keep it static, like "test_experimentee_1234" or something)

- [ ] Wave Client creates the test experiment, for example

```python
# Create the experiment
try:
    experiment = await client.experiments.create(
        experiment_type_id=exp_type_id,
        description=f"JavaScript integration demo - {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}",
        tags=[],
        additional_data={
            "created_by": "python_notebook",
            "integration_demo": True,
            "demo_type": "python_js_integration",
        },
    )
    experiment_id = str(experiment["uuid"])
    print(f"✓ Created experiment: {experiment['description']}")
    print(f"✓ Experiment ID: {experiment_id}")
except Exception as e:
    print(f"Error creating experiment: {e}")
    raise
```

- [ ] Launch the URL AGAIN, but this time with the required parameters! (but make sure the Experimentee API key is masked). For example,

```python
# Create full URL with all required parameters
full_url = (
    f"{http_url}"
    f"?key={quote(API_KEY)}"
    f"&experiment_id={quote(experiment_id)}"
    f"&participant_id={quote(sample_participant_id)}"
)

censored_url = full_url.replace(API_KEY, "[HIDDEN]")

# Open in browser with HTTP URL
print(f"\n🚀 Opening experiment in browser...")
try:
    webbrowser.open(full_url)
    print("✓ Browser opened with experiment ready to run.")
    print("💡 Server will run in background - experiment should work now!")
except Exception as e:
    print(f"❌ Could not open browser: {e}")
    print(f"📋 Manual steps:")
    print(f"   1. Open your browser")
    print(f"   2. Navigate to: {censored_url}")
    print(f"      (replace [HIDDEN] with your actual EXPERIMENTEE API key)")
```

- [ ] An input confirming whether the researcher retook the experiment with the new URL. Then, you try to pull the data

```
# Check for data periodically
print("🔍 Checking for experiment data...")
print(f"📊 Experiment ID: {experiment_id}")

try:
    # Get all data for this experiment
    data_df = await client.experiment_data.get_all_data(experiment_id=experiment_id)

    if len(data_df) > 0:
        print(f"✅ Found {len(data_df)} data points!")
        print(f"📈 Participants: {data_df['participant_id'].nunique()}")
        print(
            f"📈 Latest trial: {data_df['trial_number'].max() if 'trial_number' in data_df.columns else 'N/A'}"
        )

        display(data_df)

    else:
        print("⏳ No data found yet. Complete the web experiment first.")
        print("   Then run this cell again to check for data.")

except Exception as e:
    print(f"❌ Error retrieving data: {e}")
```


- [ ] An input confirming Y/N that the LOGGED data is as expected. If not, clean up all test data

```python
# Clean up the demo data
print("🧹 Cleaning up demo data...")
print("⚠️  This will delete the experiment and all associated data.")
try:
    # Get all data for this experiment to delete
    all_data = await client.experiment_data.get_all_data(experiment_id)

    # Delete all experiment data first
    if len(all_data) > 0:
        print(f"Deleting {len(all_data)} data points...")
        deleted_count = 0

        for _, row in all_data.iterrows():
            try:
                await client.experiment_data.delete_row(experiment_id, int(row["id"]))
                deleted_count += 1
            except Exception as e:
                print(f"  Failed to delete row {row['id']}: {e}")

        print(f"✓ Deleted {deleted_count} data rows")
    else:
        print("ℹ️  No experiment data found to delete")

    # Delete the experiment
    delete_response = await client.experiments.delete(experiment_id)
    print(f"✓ Deleted experiment: {experiment_id}")

    # Delete the experiment type
    delete_type_response = await client.experiment_types.delete(exp_type_id)
    print(f"✓ Deleted experiment type: {exp_type_id}")

    print("\n✅ Cleanup complete!")

except Exception as e:
    print(f"❌ Error during cleanup: {e}")
    print("You may need to manually delete the experiment data.")
```

DO NOT DELETE THE EXPERIMENT TYPE IF THE BOOLEAN FLAG FOR EXPERIMENT TYPE CREATION IS FALSE, OBVIOUSLY.

- [ ] If the logged data is as expected by the researcher, we now prompt them for an experiment name and they can type it
- [ ] Create the experiment, and display a status message that they're good to go to run their thing at scale via the experimentation platform, again cautioning them to only distribute EXPERIMENTEE level keys
- [ ] A markdown cell needs to be at the top of the notebook summarizing what this notebook does